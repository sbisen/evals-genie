"""
Seed script to populate demo data for Context sections
Run this script to add sample data to the database
"""
import asyncio
from motor.motor_asyncio import AsyncIOMotorClient
from datetime import datetime
import os
from dotenv import load_dotenv

load_dotenv()

MONGODB_URI = os.getenv("MONGODB_URI", "mongodb://localhost:27017")
DATABASE_NAME = "evalsgenie"

async def seed_context_data():
    """Seed demo data for all context sections"""
    client = AsyncIOMotorClient(MONGODB_URI)
    db = client[DATABASE_NAME]
    
    domain_id = "maps"
    
    print("üå± Starting to seed demo data...")
    
    # 1. Agent I/O Samples
    print("\nüìù Seeding Agent I/O samples...")
    agent_io_collection = db["agent_io_samples"]
    
    agent_io_samples = [
        {
            "domain_id": domain_id,
            "input": '{"query": "What is the total revenue for Q4 2024?", "user_id": "analyst_001"}',
            "output": '{"revenue": 2500000, "currency": "USD", "quarter": "Q4", "year": 2024, "confidence": 0.98}'
        },
        {
            "domain_id": domain_id,
            "input": '{"query": "Show me the top 5 performing products", "filters": {"category": "electronics"}}',
            "output": '{"products": ["Laptop Pro", "Wireless Mouse", "USB-C Hub", "Monitor 27\\"", "Keyboard Mech"], "metric": "revenue", "period": "last_30_days"}'
        },
        {
            "domain_id": domain_id,
            "input": '{"query": "Generate a summary report for the sales team", "format": "pdf"}',
            "output": '{"report_id": "RPT-2024-001", "status": "generated", "download_url": "/reports/sales-summary-2024.pdf", "pages": 15}'
        }
    ]
    
    # Clear existing and insert new
    await agent_io_collection.delete_many({"domain_id": domain_id})
    if agent_io_samples:
        await agent_io_collection.insert_many(agent_io_samples)
    print(f"‚úÖ Added {len(agent_io_samples)} Agent I/O samples")
    
    # 2. User Stories
    print("\nüë• Seeding User Stories...")
    user_stories_collection = db["user_stories"]
    
    user_stories = [
        {
            "domain_id": domain_id,
            "story": "As an Ads Campaign Manager, I need to analyze user engagement trends so that I can prioritize the Ads targeting effectively."
        },
        {
            "domain_id": domain_id,
            "story": "As a Data Scientist in Ads Domain, I want to build predictive models for ad performance so that I can forecast campaign outcomes and optimize bidding strategies."
        },
        {
            "domain_id": domain_id,
            "story": "As a Product Manager in Ads Domain, I need to understand user behavior patterns from ad interactions so that I can improve ad product features and user experience."
        }
    ]
    
    await user_stories_collection.delete_many({"domain_id": domain_id})
    if user_stories:
        await user_stories_collection.insert_many(user_stories)
    print(f"‚úÖ Added {len(user_stories)} User Stories")
    
    # 3. Prompts
    print("\nüí¨ Seeding Prompts...")
    prompts_collection = db["prompts"]
    
    prompts = [
        {
            "domain_id": domain_id,
            "key": "system-prompt",
            "type": "system",
            "content": "You are an AI assistant specialized in business intelligence and data analysis. Always provide accurate, data-driven insights based on the available information. If you're unsure about any data, clearly state your uncertainty."
        },
        {
            "domain_id": domain_id,
            "key": "error-handling",
            "type": "prompt",
            "content": "If a query cannot be answered due to missing data or insufficient permissions, provide a helpful explanation and suggest alternative approaches or data sources that might help."
        },
        {
            "domain_id": domain_id,
            "key": "data-validation",
            "type": "system",
            "content": "Always validate data quality before presenting results. Flag any anomalies, outliers, or data quality issues. Provide confidence scores when appropriate."
        }
    ]
    
    await prompts_collection.delete_many({"domain_id": domain_id})
    if prompts:
        await prompts_collection.insert_many(prompts)
    print(f"‚úÖ Added {len(prompts)} Prompts")
    
    # 4. Training Examples (Sample Q&A)
    print("\nüìö Seeding Training Examples...")
    training_collection = db["training_examples"]
    
    training_examples = [
        {
            "domain_id": domain_id,
            "question": "What is the revenue generated by our top performing Facebook ads in California?",
            "golden_answer": "The top 3 performing Facebook ads in California generated $485,000 in total revenue: 1) 'Tech Sale 2024' ad ($210,000), 2) 'Holiday Special' ad ($165,000), and 3) 'New Product Launch' ad ($110,000). California represents 18% of our total Facebook ad revenue."
        },
        {
            "domain_id": domain_id,
            "question": "Which ad creative has the highest CTR in our Google Search campaigns?",
            "golden_answer": "The 'Holiday Sale 2024' ad creative has the highest CTR at 5.2% with 8,450 clicks from 162,500 impressions. This is 37% higher than our average campaign CTR of 3.8%."
        }
    ]
    
    await training_collection.delete_many({"domain_id": domain_id})
    if training_examples:
        await training_collection.insert_many(training_examples)
    print(f"‚úÖ Added {len(training_examples)} Training Examples")
    
    # 5. Test Sets (with varied statuses - 82% pass rate for demo)
    print("\nüß™ Seeding Test Sets...")
    test_sets_collection = db["test_sets"]
    
    test_sets = [
        {
            "domain_id": domain_id,
            "question": "What is the CTR (Click-Through Rate) for our Google Search campaigns in the last 30 days?",
            "ground_truth": "The CTR for Google Search campaigns in the last 30 days is 3.8%, with 45,230 clicks from 1,190,526 impressions. This is 0.5% above the industry benchmark of 3.3%.",
            "difficulty": "medium",
            "last_status": "pass",
            "last_agent_answer": "Google Search CTR: 3.8% (45,230 clicks / 1,190,526 impressions), 0.5% above benchmark",
            "last_evaluation_reasoning": "Correct calculation with benchmark comparison",
            "confidence_score": 95.8
        },
        {
            "domain_id": domain_id,
            "question": "Which ad campaigns have the highest ROAS (Return on Ad Spend)?",
            "ground_truth": "Top 3 campaigns by ROAS: 1) Brand Search (8.2x ROAS, $82K revenue on $10K spend), 2) Retargeting Display (5.4x, $135K on $25K), 3) Shopping Ads (4.8x, $240K on $50K).",
            "difficulty": "easy",
            "last_status": "pass",
            "last_agent_answer": "Top ROAS: Brand Search 8.2x, Retargeting Display 5.4x, Shopping Ads 4.8x",
            "last_evaluation_reasoning": "Accurate ranking with ROAS values and supporting data",
            "confidence_score": 98.2
        },
        {
            "domain_id": domain_id,
            "question": "What is the average CPA (Cost Per Acquisition) across all paid channels?",
            "ground_truth": "Average CPA across all paid channels is $42.50, calculated from 2,847 conversions at $121,000 total ad spend. By channel: Google Ads $38, Facebook $45, LinkedIn $67, Display $52.",
            "difficulty": "hard",
            "last_status": "pass",
            "last_agent_answer": "Avg CPA: $42.50 overall (Google $38, Facebook $45, LinkedIn $67, Display $52)",
            "last_evaluation_reasoning": "Correct CPA calculation with channel breakdown",
            "confidence_score": 92.5
        },
        {
            "domain_id": domain_id,
            "question": "Show the conversion funnel for our Facebook ad campaigns",
            "ground_truth": "Facebook ad funnel: Impressions (1.2M) ‚Üí Clicks (36K, 3% CTR) ‚Üí Landing Page Views (28.8K, 80% view rate) ‚Üí Add to Cart (5.76K, 20% cart rate) ‚Üí Purchase (1.44K, 25% checkout rate). Overall conversion: 0.12%.",
            "difficulty": "medium",
            "last_status": "warn",
            "last_agent_answer": "Facebook funnel: 1.2M impressions ‚Üí 36K clicks (3% CTR) ‚Üí 28.8K views ‚Üí 5.76K carts",
            "last_evaluation_reasoning": "Missing final purchase step and overall conversion rate",
            "confidence_score": 78.3
        },
        {
            "domain_id": domain_id,
            "question": "What is the average CPM (Cost Per Thousand Impressions) by ad placement?",
            "ground_truth": "Average CPM by placement: Facebook Feed $12.50, Instagram Stories $15.80, Google Display Network $8.20, YouTube Pre-roll $18.40. Instagram Stories has the highest CPM at 2.2x the GDN rate.",
            "difficulty": "easy",
            "last_status": "pass",
            "last_agent_answer": "CPM by placement: Facebook Feed $12.50, Instagram Stories $15.80, GDN $8.20, YouTube $18.40",
            "last_evaluation_reasoning": "Accurate CPM values with clear comparison",
            "confidence_score": 96.7
        },
        {
            "domain_id": domain_id,
            "question": "Calculate the total ad spend and revenue for Q4 2024",
            "ground_truth": "Q4 2024 totals: $485,000 ad spend generating $2,425,000 in attributed revenue, resulting in a 5.0x ROAS. This represents a 15% increase in efficiency compared to Q3 (4.35x ROAS).",
            "difficulty": "medium",
            "last_status": "pass",
            "last_agent_answer": "Q4 2024: $485K spend, $2.425M revenue, 5.0x ROAS (15% improvement vs Q3)",
            "last_evaluation_reasoning": "Correct calculations with QoQ comparison",
            "confidence_score": 94.1
        },
        {
            "domain_id": domain_id,
            "question": "Identify underperforming ad campaigns that need optimization",
            "ground_truth": "7 campaigns underperforming: 3 with ROAS below 2.0x (Generic Keywords, Cold Audience Display, Broad Match Search), 2 with CTR below 1% (Banner Ads, Sidebar Display), 2 with CPA above $80 (LinkedIn Lead Gen, Premium Placement). Recommend pausing or restructuring.",
            "difficulty": "hard",
            "last_status": "fail",
            "last_agent_answer": "3 campaigns have ROAS below 2.0x: Generic Keywords, Cold Audience Display, Broad Match Search",
            "last_evaluation_reasoning": "Incomplete - only checked ROAS, missed CTR and CPA analysis",
            "confidence_score": 45.2
        },
        {
            "domain_id": domain_id,
            "question": "What is the average time to conversion from first ad click?",
            "ground_truth": "Average time to conversion is 3.2 days from first ad click. By channel: Brand Search 0.8 days, Retargeting 1.5 days, Generic Search 4.2 days, Display 6.8 days, Social 5.5 days.",
            "difficulty": "easy",
            "last_status": "pass",
            "last_agent_answer": "Avg conversion time: 3.2 days (Brand 0.8d, Retargeting 1.5d, Generic 4.2d, Display 6.8d, Social 5.5d)",
            "last_evaluation_reasoning": "Complete breakdown with channel-specific timing",
            "confidence_score": 97.4
        },
        {
            "domain_id": domain_id,
            "question": "Forecast ad spend and expected conversions for next month",
            "ground_truth": "January 2025 forecast: $165,000 ad spend (8% increase) generating 3,850 conversions at $42.86 CPA, based on seasonal trends and current performance. Expected revenue: $825,000 (5.0x ROAS maintained).",
            "difficulty": "hard",
            "last_status": "pass",
            "last_agent_answer": "Jan 2025 forecast: $165K spend, 3,850 conversions, $42.86 CPA, $825K revenue (5.0x ROAS)",
            "last_evaluation_reasoning": "Solid forecast with methodology and key metrics",
            "confidence_score": 89.6
        },
        {
            "domain_id": domain_id,
            "question": "What percentage of ad clicks resulted in conversions last week?",
            "ground_truth": "Last week, 1,247 conversions came from 89,450 ad clicks, representing a 1.39% conversion rate. This is 0.15% below our target of 1.54% and requires optimization.",
            "difficulty": "medium",
            "last_status": "fail",
            "last_agent_answer": "1,247 conversions from 89,450 clicks last week",
            "last_evaluation_reasoning": "Missing percentage calculation and target comparison",
            "confidence_score": 52.9
        },
        {
            "domain_id": domain_id,
            "question": "Show top 5 ad creatives by engagement rate",
            "ground_truth": "Top 5 by engagement: 1) Video Ad 'Product Demo' (8.5% engagement, 12K interactions), 2) Carousel 'Customer Stories' (6.2%, 9.3K), 3) Static 'Limited Offer' (5.8%, 8.7K), 4) Video 'How-To Guide' (5.4%, 7.6K), 5) Collection 'New Arrivals' (4.9%, 6.8K).",
            "difficulty": "easy",
            "last_status": "pass",
            "last_agent_answer": "Top 5 engagement: Product Demo 8.5%, Customer Stories 6.2%, Limited Offer 5.8%, How-To Guide 5.4%, New Arrivals 4.9%",
            "last_evaluation_reasoning": "Accurate ranking with engagement rates",
            "confidence_score": 93.8
        }
    ]
    
    await test_sets_collection.delete_many({"domain_id": domain_id})
    if test_sets:
        await test_sets_collection.insert_many(test_sets)
    print(f"‚úÖ Added {len(test_sets)} Test Sets")
    
    print("\nüéâ Demo data seeding completed successfully!")
    print(f"\nSummary:")
    print(f"  - Agent I/O Samples: {len(agent_io_samples)}")
    print(f"  - User Stories: {len(user_stories)}")
    print(f"  - Prompts: {len(prompts)}")
    print(f"  - Training Examples: {len(training_examples)}")
    print(f"  - Test Sets: {len(test_sets)}")
    print(f"\n‚ú® You can now view this data in the frontend!")
    
    client.close()

if __name__ == "__main__":
    asyncio.run(seed_context_data())